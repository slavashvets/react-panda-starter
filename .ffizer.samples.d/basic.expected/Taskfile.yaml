version: "3"

tasks:
  env-check:
    internal: true
    silent: true
    run: once
    desc: Ensure we are inside a Git repo and have required CLI tools
    preconditions:
      - sh: git rev-parse --is-inside-work-tree >/dev/null 2>&1
        msg: Not a Git repository. Run "git init" first.
      - sh: command -v bun >/dev/null
        msg: Bun is not installed → https://bun.sh/
      - sh: command -v lefthook >/dev/null
        msg: Lefthook is not installed → https://lefthook.dev/installation/index.html

  install-lefthook:
    silent: true
    deps: [env-check]
    desc: Install Lefthook hooks (runs only if not yet installed)
    status:
      - >
        test -f "$(git rev-parse --git-dir)/hooks/pre-commit" \
        && grep -q 'Generated by Lefthook' "$(git rev-parse --git-dir)/hooks/pre-commit"
    cmds:
      - lefthook install

  install-deps:
    silent: true
    deps: [env-check]
    desc: Install dependencies (runs if node_modules missing)
    cmds:
      - bun install

  prepare:
    desc: Prepare the project
    silent: true
    deps:
      - install-lefthook
      - install-deps

  "*":
    deps:
      - prepare
    desc: "Run a command from the package.json scripts (dev, build, lint, etc.)"
    cmds:
      - bun run {{ index .MATCH 0 }} {{.CLI_ARGS}}
